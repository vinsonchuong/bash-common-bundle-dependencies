#!/usr/bin/env bash
set -o errexit
set -o nounset
# set -o xtrace
set -o pipefail

eval "$(environment)"
eval "$(parse-options help:h -- "$@")"

if [[ $help ]]
then
	cat "$HELP"
	exit
fi

declare -A dependencies
dependencies['bash']='seen'
dependencies['git']='seen'

queue=('bats-git')

eval "$(cat 'PKGBUILD')"
queue=("${queue[@]+"${queue[@]}"}" "${depends[@]+"${depends[@]}"}" "${optdepends[@]+"${optdepends[@]}"}" "${makedepends[@]+"${makedepends[@]}"}" "${checkdepends[@]+"${checkdepends[@]}"}")

mkdir 'packages'
cd 'packages'

while [[ ${#queue[@]} -gt 0 ]]
do
	dependency=${queue[0]}
	queue=("${queue[@]:1}")

	if [[ ${dependencies["$dependency"]+'seen'} ]]
	then
		continue
	fi
	dependencies["$dependency"]='seen'

	depends=()
	optdepends=()
	eval "$(curl -sfL "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=${dependency}")"

	echo "Bundling: ${dependency}"

	url="${source[0]}"
	if [[ $url = 'git+'* ]]
	then
		git clone -q "${url#*+}"
	fi
	if [[ $url = 'http'* ]]
	then
		curl -sfL "$url" | tar -xz
	fi

	queue=("${queue[@]+"${queue[@]}"}" "${depends[@]+"${depends[@]}"}" "${optdepends[@]+"${optdepends[@]}"}")
done

echo 'Linking bin files to packages/bin'
mkdir 'bin'
for bin in $(ls */bin/*)
do
	ln -s "${PWD}/${bin}" 'bin'
done
