#!/usr/bin/env bash
set -o errexit
set -o nounset
# set -o xtrace
set -o pipefail

eval "$(environment)"
eval "$(parse-options help:h -- "$@")"

if [[ $help ]]
then
	cat "$HELP"
	exit
fi

declare -A dependencies
dependencies['bash']='seen'
dependencies['git']='seen'

queue=('bats-git')

eval "$(cat 'PKGBUILD')"
queue=("${queue[@]+"${queue[@]}"}" "${depends[@]+"${depends[@]}"}" "${optdepends[@]+"${optdepends[@]}"}" "${makedepends[@]+"${makedepends[@]}"}" "${checkdepends[@]+"${checkdepends[@]}"}")

while [[ ${#queue[@]} -gt 0 ]]
do
	dependency=${queue[0]}
	queue=("${queue[@]:1}")

	if [[ ${dependencies["$dependency"]+'seen'} ]]
	then
		continue
	fi
	dependencies["$dependency"]='seen'

	echo "Bundling: ${dependency}"

	depends=()
	optdepends=()
	makedepends=()
	checkdepends=()
	eval "$(curl "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=${dependency}")"
	queue=("${queue[@]+"${queue[@]}"}" "${depends[@]+"${depends[@]}"}" "${optdepends[@]+"${optdepends[@]}"}" "${makedepends[@]+"${makedepends[@]}"}" "${checkdepends[@]+"${checkdepends[@]}"}")
done
